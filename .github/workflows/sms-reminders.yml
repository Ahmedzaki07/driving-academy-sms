name: SMS Reminders Automation

on:
  schedule:
    # Run every 5 minutes
    - cron: '*/5 * * * *'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode (manual trigger)'
        required: false
        default: 'false'
        type: boolean

jobs:
  send-reminders:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Send SMS Reminders
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        FUNCTION_URL: ${{ secrets.SUPABASE_FUNCTION_URL }}
      run: |
        echo "ğŸ• Starting SMS Reminder Check..."
        echo "ğŸ“… Current time: $(date)"
        
        # Test mode for manual triggers
        if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
          echo "ğŸ§ª Test mode enabled - manual trigger"
          FUNCTION_URL="${FUNCTION_URL}?manual=true"
        fi
        
        # Call the Edge Function
        response=$(curl -s -w "\n%{http_code}" \
          -X POST \
          -H "Authorization: Bearer ${SERVICE_ROLE_KEY}" \
          -H "Content-Type: application/json" \
          -d '{}' \
          "${FUNCTION_URL}")
        
        # Extract response body and status code
        http_code=$(echo "$response" | tail -n1)
        response_body=$(echo "$response" | head -n -1)
        
        echo "ï¿½ï¿½ HTTP Status: $http_code"
        echo "ğŸ“Š Response: $response_body"
        
        # Check if successful
        if [ "$http_code" -eq 200 ]; then
          echo "âœ… SMS Reminder function executed successfully!"
          
          # Parse results if response is valid JSON
          if echo "$response_body" | jq -e . >/dev/null 2>&1; then
            student_sent=$(echo "$response_body" | jq -r '.results.studentReminders.sent // 0')
            student_failed=$(echo "$response_body" | jq -r '.results.studentReminders.failed // 0')
            captain_sent=$(echo "$response_body" | jq -r '.results.captainReminders.sent // 0')
            captain_failed=$(echo "$response_body" | jq -r '.results.captainReminders.failed // 0')
            
            echo "ï¿½ï¿½ Student Reminders: $student_sent sent, $student_failed failed"
            echo "ğŸ‘¨â€ï¿½ï¿½ Captain Reminders: $captain_sent sent, $captain_failed failed"
          fi
        else
          echo "âŒ SMS Reminder function failed with status: $http_code"
          echo "ğŸ“ Error details: $response_body"
          exit 1
        fi
        
        echo "âœ… SMS Reminder automation completed!"
